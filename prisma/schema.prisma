generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ========== 認証関連 (NextAuth.js) ==========

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ========== ユーザー ==========

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?

  // プロフィール
  displayName String?
  bio         String? @db.Text

  // 統計
  totalScore     Int @default(0)
  quizzesTaken   Int @default(0)
  quizzesCreated Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // リレーション
  accounts        Account[]
  sessions        Session[]
  quizzes         Quiz[]          @relation("CreatedQuizzes")
  answerHistories AnswerHistory[]
  scores          Score[]
  likes           Like[]
  feedbacks       Feedback[]
  comments        Comment[]

  @@index([totalScore(sort: Desc)])
}

// ========== カテゴリ・タグ ==========

model Category {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  description String?
  icon        String?
  order       Int     @default(0)

  createdAt DateTime @default(now())

  quizzes Quiz[]
}

model Tag {
  id   String @id @default(cuid())
  name String @unique
  slug String @unique

  quizzes QuizTag[]
}

model QuizTag {
  quizId String
  tagId  String

  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([quizId, tagId])
}

// ========== クイズ ==========

model Quiz {
  id          String  @id @default(cuid())
  title       String
  description String? @db.Text

  // 作成者
  authorId String
  author   User   @relation("CreatedQuizzes", fields: [authorId], references: [id])

  // カテゴリ
  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])

  // 設定
  status       String  @default("draft") // draft, published
  isPublic     Boolean @default(true)
  timeLimit    Int? // 制限時間（秒）、nullは無制限
  passingScore Int     @default(60) // 合格点（%）

  // 統計
  playCount Int   @default(0)
  avgScore  Float @default(0)
  likeCount Int   @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime? // 公開日時

  // リレーション
  questions Question[]
  tags      QuizTag[]
  scores    Score[]
  likes     Like[]
  comments  Comment[]

  @@index([categoryId])
  @@index([authorId])
  @@index([status])
  @@index([playCount(sort: Desc)])
  @@index([createdAt(sort: Desc)])
}

model Question {
  id     String @id @default(cuid())
  quizId String
  quiz   Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)

  // 問題内容
  content     String  @db.Text
  explanation String? @db.Text // 解説
  imageUrl    String?

  // 選択肢（JSON配列）
  options Json // ["選択肢A", "選択肢B", "選択肢C", "選択肢D"]

  // 正解インデックス（0から始まる配列）
  correctIndices Json // [0] or [0, 2] for multiple correct answers

  // 複数回答を許可するかどうか
  isMultipleChoice Boolean @default(false)

  // 並び順
  order Int @default(0)

  // 配点
  points Int @default(10)

  createdAt DateTime @default(now())

  answerHistories AnswerHistory[]

  @@index([quizId])
}

// ========== 回答・スコア ==========

model AnswerHistory {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  // 回答内容
  selectedIndices Json // [0] or [0, 2] for multiple selections
  isCorrect       Boolean
  timeSpent     Int? // 回答にかかった時間（秒）

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([questionId])
  @@index([userId, questionId])
}

model Score {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  quizId String
  quiz   Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)

  // スコア情報
  score        Int   // 獲得点数
  maxScore     Int   // 最大点数
  percentage   Float // パーセンテージ
  correctCount Int   // 正解数
  totalCount   Int   // 問題数

  timeSpent Int? // 総回答時間（秒）

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([quizId])
  @@index([score(sort: Desc)])
  @@index([createdAt(sort: Desc)])
}

// ========== お気に入り ==========

model Like {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  quizId String
  quiz   Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, quizId])
  @@index([userId])
  @@index([quizId])
}

// ========== フィードバック ==========

model Feedback {
  id       String @id @default(cuid())
  userId   String?
  user     User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  category String  // inquiry, feature_request, bug_report, other
  content  String  @db.Text
  email    String? // 未ログインユーザー用
  status   String  @default("open") // open, in_progress, resolved, closed

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([category])
  @@index([createdAt(sort: Desc)])
}

// ========== コメント ==========

model Comment {
  id      String @id @default(cuid())
  quizId  String
  quiz    Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  content String @db.Text

  // 返信用（スレッド）
  parentId String?
  parent   Comment?  @relation("Replies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[] @relation("Replies")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([quizId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt(sort: Desc)])
}
